<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentication - brunipeter94@gmail.com</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .status.info { background: #e3f2fd; border-color: #2196f3; }
        .status.success { background: #e8f5e8; border-color: #4caf50; }
        .status.error { background: #ffebee; border-color: #f44336; }
        .code {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #1976d2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Test Authentication for brunipeter94@gmail.com</h1>

        <div class="status info">
            <strong>Test Purpose:</strong> Verify that the test user credentials work with the existing Cognito setup
        </div>

        <h2>Configuration</h2>
        <div class="code" id="config">
User Pool ID: us-east-1_RIOPGg1Cq
Client ID: 2addji24p0obg5sqedgise13i4
Domain: us-east-1riopgg1cq.auth.us-east-1.amazoncognito.com
Test User: brunipeter94@gmail.com
Password: Test123!
        </div>

        <h2>Test Authentication</h2>
        <button onclick="testLogin()">Start OAuth Login Flow</button>
        <button onclick="clearResults()">Clear Results</button>

        <div id="results"></div>

        <h2>Instructions</h2>
        <ol>
            <li>Click "Start OAuth Login Flow" to open Cognito login page</li>
            <li>Enter credentials: <strong>brunipeter94@gmail.com</strong> / <strong>Test123!</strong></li>
            <li>If login succeeds, you'll be redirected back with JWT tokens</li>
            <li>This will verify the user credentials work correctly</li>
        </ol>
    </div>

    <script>
        // Cognito OAuth configuration
        const CONFIG = {
            userPoolId: 'us-east-1_RIOPGg1Cq',
            clientId: '2addji24p0obg5sqedgise13i4',
            domain: 'us-east-1riopgg1cq.auth.us-east-1.amazoncognito.com',
            redirectUri: window.location.origin + window.location.pathname,
            responseType: 'code',
            scopes: 'email openid profile'
        };

        function addResult(type, title, content) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${title}</strong><br>${content}`;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Generate PKCE challenge for secure auth
        function generateCodeChallenge() {
            const codeVerifier = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(32))))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');

            return crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier))
                .then(buffer => {
                    const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(buffer)))
                        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
                    return { codeVerifier, codeChallenge };
                });
        }

        function testLogin() {
            addResult('info', 'Starting Authentication Test...', 'Generating PKCE challenge and redirecting to Cognito');

            generateCodeChallenge().then(({ codeVerifier, codeChallenge }) => {
                // Store code verifier for later use
                sessionStorage.setItem('codeVerifier', codeVerifier);
                sessionStorage.setItem('testStartTime', Date.now().toString());

                // Build OAuth URL
                const state = btoa(JSON.stringify({ test: true, timestamp: Date.now() }));
                const authUrl = `https://${CONFIG.domain}/oauth2/authorize?` +
                    `client_id=${CONFIG.clientId}&` +
                    `response_type=${CONFIG.responseType}&` +
                    `scope=${encodeURIComponent(CONFIG.scopes)}&` +
                    `redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}&` +
                    `code_challenge=${codeChallenge}&` +
                    `code_challenge_method=S256&` +
                    `state=${state}`;

                addResult('info', 'Redirecting to Cognito...', 'Opening login page in new window');

                // Open in new window to avoid losing test page
                const authWindow = window.open(authUrl, 'cognito-auth', 'width=500,height=600');

                // Monitor for completion
                const checkClosed = setInterval(() => {
                    if (authWindow.closed) {
                        clearInterval(checkClosed);
                        addResult('info', 'Auth window closed', 'Check URL for authorization code');
                    }
                }, 1000);
            }).catch(error => {
                addResult('error', 'PKCE Generation Failed', error.message);
            });
        }

        // Check for authorization code on page load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const state = urlParams.get('state');

            if (error) {
                addResult('error', 'OAuth Error', `${error}: ${urlParams.get('error_description') || 'Unknown error'}`);
                return;
            }

            if (code && sessionStorage.getItem('codeVerifier')) {
                addResult('success', 'Authorization Code Received!', `Code: ${code.substring(0, 20)}...`);

                // Exchange code for tokens
                exchangeCodeForTokens(code, sessionStorage.getItem('codeVerifier'));
            }
        });

        async function exchangeCodeForTokens(authCode, codeVerifier) {
            try {
                addResult('info', 'Exchanging Code for Tokens...', 'Making token request to Cognito');

                const response = await fetch(`https://${CONFIG.domain}/oauth2/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: CONFIG.clientId,
                        code: authCode,
                        redirect_uri: CONFIG.redirectUri,
                        code_verifier: codeVerifier
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addResult('error', 'Token Exchange Failed', `HTTP ${response.status}: ${errorText}`);
                    return;
                }

                const tokens = await response.json();
                addResult('success', 'Tokens Received Successfully!', 'JWT tokens obtained - authentication working');

                // Decode ID token to show user info
                if (tokens.id_token) {
                    const idTokenPayload = JSON.parse(atob(tokens.id_token.split('.')[1]));
                    const userInfo = `
Email: ${idTokenPayload.email || 'Not available'}
Email Verified: ${idTokenPayload.email_verified || false}
User ID: ${idTokenPayload.sub}
Token Expires: ${new Date(idTokenPayload.exp * 1000).toLocaleString()}
                    `;
                    addResult('success', 'User Information Extracted', userInfo);
                }

                // Clean up
                sessionStorage.removeItem('codeVerifier');
                sessionStorage.removeItem('testStartTime');

                // Clear URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);

            } catch (error) {
                addResult('error', 'Token Exchange Error', error.message);
            }
        }
    </script>
</body>
</html>